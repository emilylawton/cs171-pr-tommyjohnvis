<!DOCTYPE html>
<html>

<head lang="en">
  <meta charset="UTF-8">
  <title>Tommy John Vis</title>

  <!-- Libraries -->
  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="libs/jquery/jquery-2.1.3.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/typeahead.js" charset="utf-8"></script>


  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
  <!-- Google Font -->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
  <!-- Own Stylesheet -->
  <link rel="stylesheet" type="text/css" href="css/myStyle.css">

  <!-- Vis Classes -->
  <script src="js/countvis.js"></script>
  <script src="js/playervis.js"></script>

</head>

<body>
  <div class="container">
    <h1>Tommy John Vis</h1>

    <!-- Filtering Options -->
    <div class="row">
      <form>
        X-axis:
        <label><input type="radio" name="x-axis" value="month" checked>by Month</label>
        <label><input type="radio" name="x-axis" value="year">by Year</label>
      </form>
    </div>

    <div class="row">
      <div class="col-md-9" id="countVis">
      </div>
      <div class="col-md-3" id="playerVis">
        <input type="text" id="searchPlayer" onkeypress="searchForPlayer(event)" placeholder="Enter player name...">
      </div>
    </div>

    <div class="row">
      <svg width="900" height="150" style="background-color: lightgreen">
        <text = x="50" y ="50">HERE should be little Histograms</text>
      </svg>
    </div>

    <script>

      // globals 
      var allData; 
      var MyEventHandler; 

      $(function() {
        // global data variable
        allData = [];
        // convert strings to Date objects
        var dateFormatter = d3.time.format("%m/%Y");

        // vis objects
        var countVis, playerVis;

        var initVis = function() {
          // create event handler
          MyEventHandler = new Object();

          // instantiate vis objects
          countVis = new CountVis(d3.select("#countVis"), allData, MyEventHandler);
          playerVis = new PlayerVis(d3.select("#playerVis"), allData);

          // bind event handler to vis objects
          $(MyEventHandler).bind("selectionChanged", function(event, surgery) {
            playerVis.onSelectionChange(surgery["id"]);
          });

          // all player names 
          var name_data = allData.map(function(d) { return d.player; });

          // player search box 
          // TODD: specify number of suggestions
          $('#searchPlayer').typeahead({
            hint: true, 
            highlight: true, 
            minLength: 1
          },
          {
            displayKey: 'value',
            source: substringMatcher(name_data)
          }); 
        }

        var formatData = function(error, _allData) {
          if (!error) {
            allData = _allData.map(function (d) {
              surg_split = d["TJ Surgery Date"].split("/");
              return_split = d["Return Date (same level)"].split("/");
              
              var surgeryInstance = {
                majors: d["Majors"] == "Y" ? true : false,
                post_games: parseInt(d["Post-TJ MLB G"]),
                surg_date: dateFormatter.parse(surg_split[0] + "/" + surg_split[2]),
                post_ippa: parseInt(d["Post-TJ MLB IP/PA"]),
                mlbamid: parseInt(d["mlbamid"]),
                country: d["Country"],
                age: parseInt(d["Age"]),
                surgeons: d["Surgeon(s)"],
                player: d["Player"],
                high_school: d["High School"],
                college: d["College"],
                team: d["Team"],
                active: d["active"] == "1" ? true : false,
                position: d["Position"],
                recovery: d["Recovery Time (months)"],
                return_date: dateFormatter.parse(return_split[0] + "/" + return_split[2])
              }
              return surgeryInstance;
            });

            initVis();
          }
        }

        // load data, then init vis
        var loadData = function() {
          queue()
            .defer(d3.json, "data/tjs.json")
            .await(formatData);
        }

        loadData();

        // if you should change the x axis
        d3.selectAll("input[name=\"x-axis\"]").on("change", function() {
          var setting = document.querySelector('input[name="x-axis"]:checked').value;

          countVis.changeGrouping(setting);
        });

        // find player matches as user types in search box 
        function substringMatcher(strs) {
          return function findMatches(q, cb) {
            var matches, substrRegex;
         
            // an array that will be populated with substring matches
            matches = [];
         
            // regex used to determine if a string contains the substring `q`
            substrRegex = new RegExp(q, 'i');
         
            // iterate through the pool of strings and for any string that
            // contains the substring `q`, add it to the `matches` array
            $.each(strs, function(i, str) {
              if (substrRegex.test(str)) {
                // the typeahead jQuery plugin expects suggestions to a
                // JavaScript object, refer to typeahead docs for more info
                matches.push({ value: str });
              }
            });
         
            cb(matches);
          };
        };

      });

      
      function searchForPlayer (e) {
        // if ENTER key is pressed 
        if (e.keyCode == 13) {
          var name = document.getElementById("searchPlayer").value;

          var p = allData.filter(function(d) {
            return d.player == name; 
          });

          var id = p[0]["mlbamid"];

          // trigger event to change player profile
          $(MyEventHandler).trigger("selectionChanged", {"id": id});

          // TODO: highlight surgery instances in countvis
        }
      }
  </script>
</body>

</html>