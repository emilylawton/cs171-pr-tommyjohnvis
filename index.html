<!DOCTYPE html>
<html>

<head lang="en">
  <meta charset="UTF-8">
  <title>Tommy John Vis</title>

  <!-- Libraries -->
  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="libs/jquery/jquery-2.1.3.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
  <script src="libs/bootstrap/js/typeahead.js" charset="utf-8"></script>

  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
  <!-- Google Font -->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
  <!-- Own Stylesheet -->
  <link rel="stylesheet" type="text/css" href="css/myStyle.css">

  <!-- Vis Classes -->
  <script src="js/countvis.js"></script>
  <script src="js/playervis.js"></script>
  <script src="js/recoveryvis.js"></script>

</head>

<body>
  <div class="container">
    <h1>Tommy John Vis</h1>

    <!-- Filtering Options -->
    <div class="row">
      <form>
        Grouping:
        <label><input type="radio" name="grouping" value="month">by Month</label>
        <label><input type="radio" name="grouping" value="year" checked>by Year</label>
      </form>
    </div>
    <div>
      <p>
        <label for="ageRange">Ages:</label>
        <input type="text" id="ageRange" readonly>
      <div class="col-md-5" id="ageSlider"></div>
    </div>

    <div class="row">
      <div class="col-md-9" id="countVis">
      </div>
      <div class="col-md-3" id="playerVis">
        <input type="text" id="searchPlayer" onkeypress="searchForPlayer(event)" placeholder="Enter player name...">
      </div>
    </div>

    <div class="row">
      <div class="col-md-9" id="recoveryVis">
      </div>
    </div>

    <script>

      // globals 
      var allData; 
      var MyEventHandler;
      var minAge, maxAge; 

      $(function() {
        // global data variable
        allData = [];
        // convert strings to Date objects
        var dateFormatter = d3.time.format("%m/%d/%Y");

        // vis objects
        var countVis, playerVis;

        var initVis = function() {
          // create event handler
          MyEventHandler = new Object();

          // instantiate vis objects
          countVis = new CountVis(d3.select("#countVis"), allData, MyEventHandler);
          playerVis = new PlayerVis(d3.select("#playerVis"), allData);
          recoveryVis = new RecoveryVis(d3.select("#recoveryVis"), allData);

          // bind event handler to vis objects
          $(MyEventHandler).bind("selectionChanged", function(event, surgery) {
            playerVis.onSelectionChange(surgery["id"]);
          });

          $(MyEventHandler).bind("brushChanged", function(event, extent) {
            recoveryVis.onBrushChange(extent["start"], extent["end"]);
          });

          // all player names 
          var name_data = allData.map(function(d) { return d.player; });

          // player search box 
          // TODD: specify number of suggestions
          $('#searchPlayer').typeahead({
            hint: true, 
            highlight: true, 
            minLength: 2,
          },
          {
            displayKey: 'value',
            source: substringMatcher(name_data)
          }); 

          var minMax = countVis.findMinMax();
          // add slider
          $("#ageSlider").slider({
            range: true,
            min: minMax[0],
            max: minMax[1],
            values: [minMax[0], minMax[1]],
            slide: function( event, ui ) {
              // change display values
              $("#ageRange").val(ui.values[0] + " - " + ui.values[1]);
              
              countVis.userChange(displaySettings());
            }
          });
          
          $("#ageRange").val($("#ageSlider").slider("values",0) +
            " - " + $("#ageSlider").slider("values",1));
        }

        var formatData = function(error, _allData) {
          if (!error) {
  
            allData = _allData.map(function (d) {
              surg_split = d["TJ Surgery Date"].split("/");
              return_split = d["Return Date (same level)"].split("/");
              
              var surgeryInstance = {
                majors: d["Majors"] == "Y" ? true : false,
                post_games: parseInt(d["Post-TJ MLB G"]),
                surg_date: dateFormatter.parse(surg_split[0] + "/" + surg_split[1] + "/" + surg_split[2]),
                post_ippa: parseInt(d["Post-TJ MLB IP/PA"].replace(/,/g, '')),
                mlbamid: parseInt(d["mlbamid"]),
                country: d["Country"],
                age: parseInt(d["Age"]),
                surgeons: d["Surgeon(s)"],
                player: d["Player"],
                high_school: d["High School"],
                college: d["College"],
                team: d["Team"],
                active: parseInt(d["Active"]) == 1 ? true : false,
                position: d["Position"],
                recovery: parseInt(d["Recovery Time (months)"]),
                return_date: dateFormatter.parse(return_split[0] + "/" + return_split[2]),
                throwing_arm: d["Throws"]
              }
              return surgeryInstance;
            });

            initVis();
          }
        }

        // load data, then init vis
        var loadData = function() {
          queue()
            .defer(d3.json, "data/tjs.json")
            .await(formatData);
        }

        loadData();

        // when the grouping is changed
        d3.selectAll("input[name=\"grouping\"]").on("change", function() {
          countVis.userChange(displaySettings());
        });

        // find player matches as user types in search box 
        function substringMatcher(strs) {
          return function findMatches(q, cb) {
            var matches, substrRegex;
         
            // an array that will be populated with substring matches
            matches = [];
         
            // regex used to determine if a string contains the substring `q`
            substrRegex = new RegExp(q, 'i');
         
            // iterate through the pool of strings and for any string that
            // contains the substring `q`, add it to the `matches` array
            // NOTE: matches.length < 1 is a hacky way of restricting the 
            // matches list to only 1. 
            // TODO: use maxLength attribute instead 
            $.each(strs, function(i, str) {
              if (substrRegex.test(str) && matches.length < 1) {
                // the typeahead jQuery plugin expects suggestions to a
                // JavaScript object, refer to typeahead docs for more info
                matches.push({ value: str });
              }
            });
         
            cb(matches);
          };
        };

      });

      
      function searchForPlayer (e) {
        // TODO: have a search button instead of having user press enter? 

        // if ENTER key is pressed 
        if (e.keyCode == 13) {
          var name = document.getElementById("searchPlayer").value;

          var p = allData.filter(function(d) {
            return d.player.toLowerCase() == name.toLowerCase(); 
          });

          var id = p[0]["mlbamid"];

          // trigger event to change player profile 
          $(MyEventHandler).trigger("selectionChanged", {"id": id});

          // change style of node that represents the player the user searched for
          var clickEvent = document.createEvent("SVGEvents");
          clickEvent.initEvent("click",true,true);
          var node = document.getElementById(id);
          if (node) { 
            // fire the event assigned to .on("click", ...)
            node.dispatchEvent(clickEvent)
          }      
        }
      }

      // returns an object [grouping, ages] where grouping can be "month" or "year"
      // ages is min and max value of the slider
      function displaySettings() {
        var g = document.querySelector('input[name="grouping"]:checked').value;
        var a = [$("#ageSlider").slider("values",0), $("#ageSlider").slider("values",1)]; 
        return {grouping: g, ages: a}
      }
  </script>
</body>

</html>